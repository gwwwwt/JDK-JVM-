# JVM参数 JavaVMOption

## 1. JavaVMOption结构体

```c
//jni.h
/*
 * optionString may be any option accepted by the JVM, or one of the
 * following:
 *
 * -D<name>=<value>          Set a system property.
 * -verbose[:class|gc|jni]   Enable verbose output, comma-separated. E.g.
 *                           "-verbose:class" or "-verbose:gc,class"
 *                           Standard names include: gc, class, and jni.
 *                           All nonstandard (VM-specific) names must begin
 *                           with "X".
 * vfprintf                  extraInfo is a pointer to the vfprintf hook.
 * exit                      extraInfo is a pointer to the exit hook.
 * abort                     extraInfo is a pointer to the abort hook.
 */
typedef struct JavaVMOption {
    char *optionString;
    void *extraInfo;
} JavaVMOption;

```



## 2. options数组

```c
//Java.c
//--- 相关变量定义
static JavaVMOption *options; //所有JVM选项
static int numOptions; //option数量
static int maxOptions; //option最大数量限制
```



## 3. AddOption() 函数

> **作用： 添加JVM选项到options数组中，空间不够时对options进行扩容**

```c
void AddOption(char *str, void *info)
{
    //初始化或扩容options数组
    if (numOptions >= maxOptions) {
        if (options == 0) {
            maxOptions = 4;
            options = JLI_MemAlloc(maxOptions * sizeof(JavaVMOption));
        } else {
            JavaVMOption *tmp;
            maxOptions *= 2;
            tmp = JLI_MemAlloc(maxOptions * sizeof(JavaVMOption));
            memcpy(tmp, options, numOptions * sizeof(JavaVMOption));
            JLI_MemFree(options);
            options = tmp;
        }
    }
    //options[numOptions]位置的 JavaVMOption字段值
    options[numOptions].optionString = str;
    options[numOptions++].extraInfo = info;
  
    /*处理具体的JVM选项, 
			-Xss: 设置线程栈size threadStackSize, 对于小于 64KB的值, 初始化为64KB
			-Xmx: 设置最大堆容量 maxHeapSize
			-Xms: 设置初始堆容量 initialHeapSize
		*/
		if (JLI_StrCCmp(str, "-Xss") == 0) {
    		jlong tmp;
    		if (parse_size(str + 4, &tmp)) {
        		threadStackSize = tmp;
        		if (threadStackSize < (jlong)STACK_SIZE_MINIMUM) {
            		threadStackSize = STACK_SIZE_MINIMUM;
        		}
    		}
		}

		if (JLI_StrCCmp(str, "-Xmx") == 0) {
    		jlong tmp;
    		if (parse_size(str + 4, &tmp)) {
        		maxHeapSize = tmp;
    		}
		}

		if (JLI_StrCCmp(str, "-Xms") == 0) {
    		jlong tmp;
    		if (parse_size(str + 4, &tmp)) {
       			initialHeapSize = tmp;
    		}
		}
}
```
